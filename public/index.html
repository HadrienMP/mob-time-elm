<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&family=Oswald&display=swap"
          rel="stylesheet"/>
    <title>tenpo kulupu</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>

<pre id="elm"></pre>
<script src="/js/main.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>

    const app = Elm.Main.init({
        node: document.getElementById('elm'),
        flags: JSON.parse(window.localStorage.getItem("preferences")) || {volume: 50}
    });

    let alarm = document.createElement("audio");
    document.body.appendChild(alarm);

    // -----------------------------------------
    // IO
    // -----------------------------------------
    app.ports.commands.subscribe(command => {
        switch (command.name) {
            case "SoundAlarm":
                alarm.play();
                break;
            case "SetAlarm":
                alarm.src = "/sound/" + command.value;
                alarm.load();
                break;
            case "StopAlarm":
                alarm.pause();
                alarm.src = '';
                break;
            case 'CopyInPasteBin':
                navigator.clipboard
                    .writeText(command.value)
                    .finally(() => app.ports.events.send({name: 'Copied', value: ""}))
                break;
            case 'ChangeVolume':
                window.localStorage.setItem("preferences", JSON.stringify({volume: parseInt(command.value)}));
                alarm.volume = parseInt(command.value) / 100.0;
                break;
        }
    });
    alarm.addEventListener("ended", () => {
        app.ports.events.send({name: "AlarmEnded", value: ""});
    });

    // -----------------------------------------
    // Socket IO
    // -----------------------------------------

    const socket = io();
    socket.on('connect', () => {
        console.log("connected")
        setTimeout(() => socket.emit('join', 'mob'), 500);
    });
    app.ports.sendEvent.subscribe(event => {
        socket.emit('message', 'mob', event);
    });
    socket.on('message', data => {
        console.log(data);
        return app.ports.receiveEvent.send(data);
    });
    socket.on('history', app.ports.receiveHistory.send);
    // -----------------------------------------
</script>
</body>
</html>
