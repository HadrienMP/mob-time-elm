<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link rel="preconnect" href="https://fonts.gstatic.com"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link href="https://fonts.googleapis.com/css2?family=Fredericka+the+Great&family=Oswald&display=swap"
          rel="stylesheet"/>
    <title>Mob Time</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>

<pre id="elm"></pre>
<script src="/js/main.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>
<script>
    const app = Elm.Main.init({
        node: document.getElementById('elm'),
        flags: JSON.parse(window.localStorage.getItem("preferences")) || {volume: 50}
    });

    let alarm = document.createElement("audio");
    alarm.autoplay = true;
    document.body.appendChild(alarm);

    // -----------------------------------------
    // Tooltips
    // -----------------------------------------

    tippy('button[title]', {
        delay: 200,
        content(reference) {
            const title = reference.getAttribute('title');
            reference.removeAttribute('title');
            return title;
        },
    });

    // -----------------------------------------
    // Socket IO
    // -----------------------------------------

    const socket = io();
    app.ports.sendEvent.subscribe(event => {
        socket.emit('message', event.mob, event);
    });
    socket.on('message', data => {
        console.log(data);
        return app.ports.receiveOne.send(data);
    });
    socket.on('history', data => {
        alarm.muted = false;
        app.ports.receiveHistory.send(data);
    });

    // -----------------------------------------
    // IO
    // -----------------------------------------
    app.ports.commands.subscribe(command => {
        switch (command.name) {
            case "Join":
                socket.emit('join', command.value);
                break;
            case "SoundAlarm":
                play().catch(reason => {
                    console.error(reason);
                    alert("The alarm could not be played, please press play manually on the alarm controls once.")
                    alarm.controls = true;
                });
                break;
            case "SetAlarm":
                alarm.src = "/sound/" + command.value;
                alarm.load();
                alarm.pause();
                break;
            case "StopAlarm":
                alarm.pause();
                alarm.src = '';
                break;
            case 'CopyInPasteBin':
                navigator.clipboard
                    .writeText(command.value)
                    .finally(() => app.ports.events.send({name: 'Copied', value: ""}))
                break;
            case 'ChangeVolume':
                window.localStorage.setItem("preferences", JSON.stringify({volume: parseInt(command.value)}));
                alarm.volume = parseInt(command.value) / 100.0;
                break;
        }
    });
    alarm.addEventListener("ended", () => {
        app.ports.events.send({name: "AlarmEnded", value: ""});
    });

    function play() {
        alarm.play().catch(reason => {
            console.log(reason);
            alert("Audio is disabled in your tab, if you know how, enable it manually in the permissions");
        })
    }
</script>
</body>
</html>
